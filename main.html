<!DOCTYPE html >
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>AgaGeolocalization</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 400px;
        width: 800px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="userInfo">
      <p><img src="icon.png"> <strong>Your location:</strong></p>
      <p id="lat"></p>
      <p id="long"></p>
      <p id="accuracy"></p>
    </div>
    <div id="placesInfo">
      <p><strong>Nearby:</strong></p>
      <ul id="places">
      </ul>
    </div>    

    <script>
var map;
      var customLabel = {
        restaurant: {
          label: 'R'
        },
        bar: {
          label: 'B'
        }
      };

      function initMap() {
        console.log('initMap');
        map = new google.maps.Map(document.getElementById('map'), {
          //center: new google.maps.LatLng(52.22937, 21.01135),
          zoom: 13
        });

        // ///////////////////////////////// User position
        // var userPosOptions = {
        //   enableHighAccuracy: true,
        //   timeout: 5000,
        //   maximumAge: 0
        // };

        // function userLocation(pos) {
        //   console.log('userLocation');
        //   var crd = pos.coords;
        //   var userLat = document.getElementById('lat');
        //   var userLong = document.getElementById("long");
        //   var userAccuracy = document.getElementById("accuracy");
        //   userLat.innerHTML = `Latitude : ${crd.latitude}`;
        //   userLong.innerHTML = `Longitude: ${crd.longitude}`;
        //   userAccuracy.innerHTML = `More or less ${crd.accuracy} meters.`;

        //   var userCoords = new google.maps.LatLng(
        //     parseFloat(crd.latitude),
        //     parseFloat(crd.longitude)
        //   );
        //   //var marker = new GeolocationMarker(map);
        //   var icon = "icon.png";
        //   var userMarker = new google.maps.Marker({
        //     map: map,
        //     position: userCoords,
        //     //labelContent: "You",
        //     //label: 'Y'
        //     icon: icon
        //   });
        // };

        // function error(err) {
        //   console.warn(`ERROR(${err.code}): ${err.message}`);
        // };

        // navigator.geolocation.getCurrentPosition(userLocation, error, userPosOptions);

        // if (navigator.geolocation) {
        //   navigator.geolocation.getCurrentPosition(function (position) {
        //     console.log('geoLocation');
        //     initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        //     map.setCenter(initialLocation);
        //     //console.log(initialLocation);
        //   });
        // } 
        // /////////////////////////////////// end user position
       
        var infoWindow = new google.maps.InfoWindow;

        downloadUrl('geo.php', function(data) {
          console.log('downloadUrl');
          var xml = data.responseXML;
          // var mylat = map.getCenter().lat(); 
          // var mylng = map.getCenter().lng();
          // console.log(mylat);
          // console.log(mylng);        
          // var some = userCoords;
          // console.log(some);
          var markers = xml.documentElement.getElementsByTagName('marker');
          Array.prototype.forEach.call(markers, function(markerElem) {
            var id = markerElem.getAttribute('id');
            var name = markerElem.getAttribute('name');
            var address = markerElem.getAttribute('address');
            var type = markerElem.getAttribute('type');
            var point = new google.maps.LatLng(
              parseFloat(markerElem.getAttribute('lat')),
              parseFloat(markerElem.getAttribute('lng'))
            );


            ///////////////////////////////count distance
            var rad = function(x) {
              return x * Math.PI / 180;
            };

            function getDistance(position, point) {
              var R = 6378137; // Earthâ€™s mean radius in meter
              var dLat = rad(point.lat() - position.coords.latitude);
              var dLong = rad(point.lng() - position.coords.longitude);
              var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(rad(position.coords.latitude)) * Math.cos(rad(point.lat())) *
                Math.sin(dLong / 2) * Math.sin(dLong / 2);
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
              var d = R * c;
              console.log(d);
            };
            /////////////////////////////// end count distance

            //getDistance(position, point);


            var places = document.getElementById('places');
            places.innerHTML += '<li>'+name+', '+address+', '+type+'</li>';

            var infowincontent = document.createElement('div');
            var strong = document.createElement('strong');
            strong.textContent = name
            infowincontent.appendChild(strong);
            infowincontent.appendChild(document.createElement('br'));

            var text = document.createElement('text');
            text.textContent = address
            infowincontent.appendChild(text);
            var icon = customLabel[type] || {};
            var marker = new google.maps.Marker({
              map: map,
              position: point,
              label: icon.label
            });
            marker.addListener('click', function() {
              infoWindow.setContent(infowincontent);
              infoWindow.open(map, marker);
            });
          });
        });
      } // end init map

      ///////////////////////////////// User position
      var userPosOptions = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      };

      function userLocation(pos) {
        console.log('userLocation');
        var crd = pos.coords;
        var userLat = document.getElementById('lat');
        var userLong = document.getElementById("long");
        var userAccuracy = document.getElementById("accuracy");
        userLat.innerHTML = `Latitude : ${crd.latitude}`;
        userLong.innerHTML = `Longitude: ${crd.longitude}`;
        userAccuracy.innerHTML = `More or less ${crd.accuracy} meters.`;

        var userCoords = new google.maps.LatLng(
          parseFloat(crd.latitude),
          parseFloat(crd.longitude)
        );
        //var marker = new GeolocationMarker(map);
        var icon = "icon.png";
        var userMarker = new google.maps.Marker({
          map: map,
          position: userCoords,
          //labelContent: "You",
          //label: 'Y'
          icon: icon
        });
      };

      function error(err) {
        console.warn(`ERROR(${err.code}): ${err.message}`);
      };

      navigator.geolocation.getCurrentPosition(userLocation, error, userPosOptions);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          console.log('geoLocation');
          initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          map.setCenter(initialLocation);
          //console.log(initialLocation);
        });
      } 
      /////////////////////////////////// end user position

      function downloadUrl(url, callback) {
        console.log('downloadUrl(url, callback)');
        var request = window.ActiveXObject ?
          new ActiveXObject('Microsoft.XMLHTTP') :
          new XMLHttpRequest;

        request.onreadystatechange = function() {
          if (request.readyState == 4) {
            request.onreadystatechange = doNothing;
            callback(request, request.status);
          }
        };

        request.open('GET', url, true);
        request.send(null);
      }

      function doNothing() {}

    </script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFuaH_8dXWWtV4qDTLhobOVoB_GsljS_Y&callback=initMap">
    </script>

  </body>
</html>