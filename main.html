<!DOCTYPE html >
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Geolocalization</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>

  <body>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
              <div id="userInfo">
                <p><img src="icon.png"> <strong>Your location:</strong></p>
                <p id="lat"></p>
                <p id="long"></p>
                <p id="accuracy"></p>
              </div>
              <div id="placesInfo">
                <p><strong>Nearby:</strong></p>
                <ul id="places">
                </ul>
              </div>           
            </div>    
            <div class="col-md-8">
                <div id="map" style="width: 100%; height: 400px"></div>
            </div>
        </div>
    </div>

<!--     <div id="map"></div>
    <div id="userInfo">
      <p><img src="icon.png"> <strong>Your location:</strong></p>
      <p id="lat"></p>
      <p id="long"></p>
      <p id="accuracy"></p>
    </div>
    <div id="placesInfo">
      <p><strong>Nearby:</strong></p>
      <ul id="places">
      </ul>
    </div>  -->   

    <script>
   
      var map;
      var customLabel = {
        restaurant: {
          label: 'R'
        },
        bar: {
          label: 'B'
        }
      };

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          //center: new google.maps.LatLng(52.22937, 21.01135),
          zoom: 13
        });
  
        var infoWindow = new google.maps.InfoWindow;

        downloadUrl('geo.php', function(data) {
          var xml = data.responseXML;
          var markers = xml.documentElement.getElementsByTagName('marker');
          Array.prototype.forEach.call(markers, function(markerElem) {
            var id = markerElem.getAttribute('id');
            var name = markerElem.getAttribute('name');
            var address = markerElem.getAttribute('address');
            var type = markerElem.getAttribute('type');
            var point = new google.maps.LatLng(
              parseFloat(markerElem.getAttribute('lat')),
              parseFloat(markerElem.getAttribute('lng'))
            );

            var places = document.getElementById('places');
            places.innerHTML += '<li>'+name+', '+address+', '+type+'</li>';

            var infowincontent = document.createElement('div');
            var strong = document.createElement('strong');
            strong.textContent = name
            infowincontent.appendChild(strong);
            infowincontent.appendChild(document.createElement('br'));

            var text = document.createElement('text');
            text.textContent = address
            infowincontent.appendChild(text);
            var icon = customLabel[type] || {};
            var marker = new google.maps.Marker({
              map: map,
              position: point,
              label: icon.label
            });
            marker.addListener('click', function() {
              infoWindow.setContent(infowincontent);
              infoWindow.open(map, marker);
            });
          });
        });
      } // end init map

      ///////////////////////////////// User position
      var userPosOptions = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      };

      function userLocation(pos) {
        var crd = pos.coords;
        var userLat = document.getElementById('lat');
        var userLong = document.getElementById("long");
        var userAccuracy = document.getElementById("accuracy");
        userLat.innerHTML = `Latitude : ${crd.latitude}`;
        userLong.innerHTML = `Longitude: ${crd.longitude}`;
        userAccuracy.innerHTML = `More or less ${crd.accuracy} meters.`;

        var userCoords = new google.maps.LatLng(
          parseFloat(crd.latitude),
          parseFloat(crd.longitude)
        );
        var icon = "icon.png";
        var userMarker = new google.maps.Marker({
          map: map,
          position: userCoords,
          //labelContent: "You",
          //label: 'Y'
          icon: icon
        });
      };

      function error(err) {
        console.warn(`ERROR(${err.code}): ${err.message}`);
      };

      navigator.geolocation.getCurrentPosition(userLocation, error, userPosOptions);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          map.setCenter(initialLocation);
        });
      } 
      /////////////////////////////////// end user position

      function downloadUrl(url, callback) {

        var request = window.ActiveXObject ?
          new ActiveXObject('Microsoft.XMLHTTP') :
          new XMLHttpRequest;

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              var url = "geo.php?lat="+pos.lat+"&lng="+pos.lng;
              request.open("GET", url, true);
              request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
              request.onreadystatechange = function() {
                  if(request.readyState == 4 && request.status == 200) {
                      //alert(request.responseText);
                      request.onreadystatechange = doNothing;
                      callback(request, request.status);
                  }
              }
              request.send();
            });
          }

        // request.onreadystatechange = function() {
        //   if (request.readyState == 4) {
        //     request.onreadystatechange = doNothing;
        //     callback(request, request.status);
        //   }
        // };

        //request.open('GET', 'geo.php', true);
        //request.send(null);
      }

      function doNothing() {}

    </script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFuaH_8dXWWtV4qDTLhobOVoB_GsljS_Y&callback=initMap">
    </script>

  </body>
</html>